{{- if .Values.config.create -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "acp.configName" . }}
  labels:
    {{- include "acp.labels" . | nindent 4 }}
data:
  config.yaml: |
    {{- if ((.Values.client).rootCa) }}
    client:
      root_ca: /tls/client-ca.crt
    {{- else if .Values.certManager.enabled }}
    client:
      root_ca: /tls/ca.crt
    {{- end }}
    server:
      url: {{ .Values.serverURL }}
      {{- if .Values.ingressMtls.enabled }}
      mtls_url: "{{ .Values.serverURLMtls }}"
      {{- end }}
      {{- if or .Values.certificate.create .Values.certManager.enabled }}
      certificate:
        cert_path: "/tls/tls.crt"
        key_path: "/tls/tls.key"
      {{- end }}
      {{- if .Values.tlsDisabled }}
      dangerous_disable_tls: true
      {{- end }}
      port: {{ include "acp.portNumber" . }}
      client_certificate_header: "X-SSL-CERT"
      {{- if .Values.tlsDisabled }}
      security:
        sslredirect: false
      {{- end }}
    sql:
      {{- with .Values.sql }}
        {{- toYaml . | nindent 6 }}
      {{- else }}
      url: "postgres://root@{{ .Release.Name }}-cockroachdb-public:26257/defaultdb?sslmode=disable"
      {{- end }}
    timescale:
      {{- with .Values.timescale }}
        {{- toYaml . | nindent 6 }}
      {{- else }}
      url: "postgres://postgres:PaSsW0rD@{{ .Values.clusterName }}.{{ .Release.Namespace }}.svc.cluster.local/postgres"
      {{- end }}
    redis:
      {{- with .Values.redis }}
        {{- toYaml . | nindent 6 }}
      {{- else }}
      enabled: true
      addrs:
      - "{{ .Release.Name }}-redis-cluster-headless:6379"
      - "{{ .Release.Name }}-redis-cluster-headless:6379"
      {{- end }}
    {{- if .Values.timescale.enabled }}
    timescale:
      {{- with .Values.timescale }}
        {{- toYaml . | nindent 6 }}
      {{- else }}
      enabled: true
      {{- end }}
    {{- end }}
    {{- if .Values.fission.enabled }}
    faas:
      provider: {{ .Values.fission.provider }}
    fission:
      function_settings:
        idle_timeout: {{ .Values.fission.idleTimeout }}
    {{- end }}
    {{- with .Values.features }}
    features:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  extraconfig.yaml: |
    {{- with .Values.config.data }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
{{- end }}
