{{- if .Values.import.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "openbanking.fullname" . -}}-import
{{ include "openbanking.namespace" . | indent 2 }}
spec:
  backoffLimit: 0
  template:
    spec:
      containers:
        - name: acp-import
          image: cloudentity/openbanking-quickstart-configuration:latest
          imagePullPolicy: "IfNotPresent"
          args:
            - /app/main
            - --templates-dirs
            - /app/imports{{- if .Values.import.extraTemplate -}},/app/extra-imports{{- end }}
            - --tenant-url
            - {{ .Values.acpURL }}/system
            - --tenant
            - {{ .Values.import.tenant }}
            {{- if .Values.import.verbose }}
            - --verbose
            {{ end -}}
            - --variables-file
            - /app/vars/variables.yaml
            {{- if .Values.import.clientId }}
            - --client-id
            - {{ .Values.import.clientId }}
            {{ end }}
            {{- if .Values.import.clientSecret }}
            - --client-secret
            - {{ .Values.import.clientSecret }}
            {{- end }}
          env:
            - name: CLIENT_ROOT_CA
              valueFrom:
                secretKeyRef:
                  name: {{ template "openbanking.fullname" . -}}-tls
                  key: ca.crt
          volumeMounts:
            - name: variables
              mountPath: /app/vars
            {{- if .Values.import.extraTemplate }}
            - name: extra-templates
              mountPath: /app/extra-imports
            {{- end }}
      volumes:
        - name: variables
          configMap:
            name: {{ template "openbanking.fullname" . -}}-variables
        {{- if .Values.import.extraTemplate }}
        - name: extra-templates
          configMap:
            name: {{ template "openbanking.fullname" . -}}-extra-templates
        {{- end }}
      restartPolicy: Never
{{- end }}
